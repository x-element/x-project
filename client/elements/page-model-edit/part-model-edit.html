<link rel="import" href="../../components/core-ajax/core-ajax.html">
<link rel="import" href="../x-input/x-input.html">
<link rel="import" href="../x-select/x-select.html">
<link rel="import" href="../x-textarea/x-textarea.html">
<link rel="import" href="../x-date/x-date.html">
<link rel="import" href="../x-radio/x-radio.html">
<link rel="import" href="../x-number/x-number.html">
<link rel="import" href="../x-checkbox/x-checkbox.html">
<link rel="import" href="../x-email/x-email.html">
<link rel="import" href="../x-url/x-url.html">
<link rel="import" href="../x-money/x-money.html">
<link rel="import" href="../x-password/x-password.html">
<polymer-element name="part-model-edit" attributes="collection model_id">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <core-ajax id="get_api" method="GET" url="/explorer/resources/{{ collection }}" handleAs="json" 
      on-core-response="{{ on_get_api }}" on-core-error="{{ on_error_get_api }}"></core-ajax>

    <core-ajax id="get_schema" method="GET" url="/models/{{ model }}.json" handleAs="json" 
      on-core-response="{{ on_get_schema }}" on-core-error="{{ on_error_get_schema }}"></core-ajax>

    <core-ajax id="get_model" method="GET" url="/api/{{ collection }}/{{ model_id }}" handleAs="json" 
      on-core-response="{{ on_get_model }}" on-core-error="{{ on_error_get_model }}"></core-ajax>

    <core-ajax id="post_data" method="POST" url="/api/{{ collection }}" contentType="application/json" 
      on-core-response="{{ on_post_data }}" on-core-error="{{ on_error_post_data }}"></core-ajax>

    <core-ajax id="put_data" method="PUT" url="/api/{{ collection }}/{{ model_id }}" contentType="application/json" 
      on-core-response="{{ on_put_data }}" on-core-error="{{ on_error_put_data }}"></core-ajax>

    <form role="form" id="form"></form>

    <div class="form-group">
      <input id="update" type="button" class="btn btn-success" on-click="{{ save }}" value="{{ edit ? 'Update' : 'Save' }}">
    </div>

  </template>
  <script>
    Polymer('part-model-edit', {

      edit: true,

      form: {},

      types: {
        "string": "x-input",
        "select": "x-select",
        "date": "x-date",
        "enum": "x-radio",
        "number": "x-number",
        "email": "x-email",
        "textarea": "x-textarea",
        "url": "x-url",
        "boolean": "x-checkbox",
        "money": "x-money",
        "password": "x-password"
      },

      ready: function () {
        this.$.get_api.go();
      },

      on_get_api: function (event) {
        var api = event.detail.response;
        var model = Object.keys(api.models)[0];
        this.model = model;
        this.$.get_schema.go();
      },

      on_get_schema: function(event) {
        var schema = event.detail.response;
        this.endpoint = schema.plural || schema.name + 's';
        this.endpoint.replace('/', '');
        this.create_form(schema);
        this.$.get_model.go();
        this.edit = true;
      },

      on_error_get_schema: function (event) {

      },

      on_get_model: function (event) {
        var instance = event.detail.response;
        console.log(instance)
        this.values = instance;
      },

      on_error_get_model: function (event) {

      },

      on_post_data: function(event, response){
        alert("Elemento aggiunto o forse no");
        this.clear();
      },

      on_error_post_data: function (event) {

      },

      on_put_data: function(event, response){
        alert("Elemento aggiornato o forse no");
      },

      on_error_put_data: function (event) {

      },

      create_form: function (schema) {
        var name;
        var type;
        var property;
        var properties = schema.properties;
        for (name in properties) {
          property = properties[name];
          this.create_form_element(name, property);
        }
      },

      create_form_element: function (name, property) {
        var type = property.$type;
        var element_type = this.types[type] || 'x-input';
        var element = document.createElement(element_type);
        element.label = name;
        element.schema = property;
        this.$.form.appendChild(element);
        this.form[name] = element;
      },

      save: function (event, response){
        var values = this.values;
        var body = JSON.stringify(values);
        var ajax = this.$.post_data;
        ajax.body = body;
        ajax.go();
      },

      update: function(event, response) {
        var values = this.values;
        var body = JSON.stringify(values);
        var ajax = this.$.put_data;
        ajax.body = body;
        ajax.go();
      },

      clear: function () {
        var form = this.form;
        var name;
        var element;
        for (name in form) {
          element = form[name];
          element.value = '';
        }
        return this;
      },

      set values (values) {
        var form = this.form;
        var name;
        var value;
        var element;
        for (name in form) {
          value = values[name];
          if (value) {
            element = form[name];
            element.value = value;
          }
        }
        return this;
      },

      get values () {
        var values = {};
        var name;
        var value;
        var element;
        var form = this.form;
        for (name in form) {
          element = form[name];
          value = element.value;
          values[name] = value;
        }
        return values;
      }

    });
  </script>
</polymer-element>
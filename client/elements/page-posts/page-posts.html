<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/core-ajax/core-ajax.html">
<link rel="import" href="../part-header/part-header.html">
<link rel="import" href="../part-footer/part-footer.html">
<link rel="import" href="../part-pages/part-pages.html">
<link rel="import" href="../link-x/link-x.html">
<link rel="import" href="part-posts-items.html">
<link rel="import" href="part-posts-pages.html">
<dom-module name="page-posts">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    
    <core-ajax id="get_posts" method="GET" url="/api/posts/?filter={{ filter | stringify }}&{{ time }}" handleAs="json" 
      on-core-response="{{ on_get_posts }}" on-core-error="{{ on_error_get_posts }}"></core-ajax>

    <core-ajax id="get_count" method="GET" url="/api/posts/count" handleAs="json" 
      on-core-response="{{ on_get_count }}" on-core-error="{{ on_error_get_count }}"></core-ajax>

    <part-header></part-header>
    <div class="page container">
      <h1>Blog</h1>
      <part-posts-items items="{{ items }}"></part-posts-items>

      <x-pages count="{{ count }}" perpage="{{ filter.limit }}" current="{{ current }}"
        on-change-page="{{ on_change_page }}"></x-pages>
    </div>
    <part-footer></part-footer>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'page-posts',

    current: 0,

    count: 0,

    filter: {
      limit: 3,
      skip: 0,
      where: {},
      include: {},
      fields: {},
      orderBy: {}
    },

    stringify: function (value) {
      return JSON.stringify(value);
    },

    ready: function () {
      this.$.get_count.go();
    },

    on_get_count: function (event) {
      this.count = event.detail.response.count;
    },

    on_error_get_count: function (event) {
      console.log(event);
    },

    countChanged: function () {
      this.$.get_posts.go();
    },

    on_get_posts: function (event) {
      this.items = event.detail.response;
    },

    on_error_get_posts: function (event) {
      console.log(event);
    },

    on_change_page: function (event, detail) {
      this.time = new Date();
      this.filter.skip = detail.skip;
      this.$.get_posts.go();
    }

  });
</script>
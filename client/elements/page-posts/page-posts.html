<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/core-ajax/core-ajax.html">
<link rel="import" href="../../components/x-link/x-link.html">
<link rel="import" href="../x-header/x-header.html">
<link rel="import" href="../x-footer/x-footer.html">
<link rel="import" href="part-posts-items.html">
<link rel="import" href="part-posts-pages.html">
<polymer-element name="page-posts">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    
    <core-ajax id="get_posts" method="GET" url="/api/posts/?filter={{ filter | stringify }}&{{ time }}" handleAs="json" 
      on-core-response="{{ on_get_posts }}" on-core-error="{{ on_error_get_posts }}"></core-ajax>

    <core-ajax id="get_count" method="GET" url="/api/posts/count" handleAs="json" 
      on-core-response="{{ on_get_count }}" on-core-error="{{ on_error_get_count }}"></core-ajax>

    <x-header></x-header>
    <div class="page container">
      <h1>Blog</h1>
      <part-posts-items items="{{ items }}"></part-posts-items>

      <part-posts-pages count="{{ count }}" perpage="{{ filter.limit }}" current="{{ current }}"
        on-change-page="{{ on_change_page }}"></part-posts-pages>
    </div>
    <x-footer></x-footer>

  </template>
  <script>
    Polymer('page-posts', {

      current: 0,

      count: 0,

      filter: {
        limit: 2,
        skip: 0,
        where: {},
        include: {},
        fields: {},
        orderBy: {}
      },
 
      stringify: function (value) {
        return JSON.stringify(value);
      },

      ready: function () {
        this.$.get_count.go();
      },

      on_get_count: function (event) {
        this.count = event.detail.response.count;
      },

      on_error_get_count: function (event) {
        console.log(event);
      },

      countChanged: function () {
        this.$.get_posts.go();
      },

      on_get_posts: function (event) {
        this.items = event.detail.response;
      },

      on_error_get_posts: function (event) {
        console.log(event);
      },

      on_change_page: function (event, detail) {
        this.time = new Date();
        this.filter.skip = detail.skip;
        this.$.get_posts.go();
      }

    });
  </script>
</polymer-element>
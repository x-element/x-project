<link rel="import" href="/components/polymer/polymer.html">   
<link rel="import" href="/components/iron-ajax/iron-ajax.html">
<dom-module id="api-get-schema">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>

    <iron-ajax id="get_api" method="GET" url="{{get_api_url}}" 
      handle-as="json" last-response="{{response_api}}" on-error="on_error"></iron-ajax>

    <iron-ajax id="get_schema" method="GET" url="{{get_schema_url}}" 
      handle-as="json" last-response="{{response_schema}}" on-error="on_error"></iron-ajax>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'api-get-schema',

    properties: {
      name: {
        type: String,
        observer: 'on_change_name'
      },
      response_api: {
        type: Object,
        observer: 'on_response_api'
      },
      response_schema: {
        type: Object,
        observer: 'on_response_schema'
      },
      schema: {
        type: Object,
        notify: true,
        observer: 'on_change_schema'
      }
    },

    on_change_name: function (a, b) {
      if (this.name === '') return;
      this.get_api_url = '/explorer/resources/' + this.name;
      this.$.get_api.generateRequest();
    },

    on_change_schema: function () {
      this.fire('response', { schema: this.schema });
    },

    on_response_api: function (api) {
      var model = Object.keys(api.models)[0];
      this.model = model;
      this.get_schema_url = '/models/' + this.model + '.json';
      this.$.get_schema.generateRequest();
    },

    on_response_schema: function (schema) {
      var list = [];
      var name;
      var property;
      var properties = schema.properties;
      for (name in properties) {
        property = properties[name];
        property.name = name;
        list.push(property);
      }
      schema.properties = list;
      this.schema = schema;
    },

    on_error: function (event) {
      var error = event.detail.response;
      this.fire('error', { error: error });
    }

  });
</script>
<link rel="import" href="../filter-text/filter-text.html">
<link rel="import" href="../filter-date/filter-date.html">
<link rel="import" href="../filter-number/filter-number.html">
<polymer-element name="part-collection-filter" attributes="properties">
	<template>
    <style>
      :host {
        display: block;
        margin-bottom: 8px;
      }

      #select {
        display: none;
      }
      #select[visible] {
        display: inline-block;
      }

      .filter {
        display: inline-block;
        margin-bottom: 4px;
      }
    </style>

    <div id="filters">
      <template repeat="{{ property, index in used }}">
        <template if="{{ index === 0 }}">
          <span>where </span>
        </template>
        <template if="{{ index > 0}}">
          <span>and </span> 
        </template>  
        <template if="{{ property.type === 'string' }}">
          <div class="filter">
            <filter-text filter name="{{ property.name }}" placeholder="{{ property.name }}"></filter-text>
            <button class="btn btn-xs btn-default" data-name="{{ property.name }}" data-index="{{ index }}"
              on-click="{{ on_unselect }}">remove</button>
          </div>
        </template>
        <template if="{{ property.type === 'date' }}">
          <div class="filter">
            <filter-date filter name="{{ property.name }}" placeholder="{{ property.name }}"></filter-date>
            <button class="btn btn-xs btn-default" data-name="{{ property.name }}" data-index="{{ index }}"
              on-click="{{ on_unselect }}">remove</button>
          </div>
        </template>          
        <template if="{{ property.type === 'number' }}">
          <div class="filter">
            <filter-number filter name="{{ property.name }}" placeholder="{{ property.name }}"></filter-number>
            <button class="btn btn-xs btn-default" data-name="{{ property.name }}" data-index="{{ index }}"
              on-click="{{ on_unselect }}">remove</button>
          </div>
        </template>
        <br>        
      </template>
    </div>

    <div>
      <template if="{{ !used.length && unused.length }}">
        <span>where</span>
      </template>
      <template if="{{ used.length && unused.length }}">
        <span>and</span>
      </template>
      <select id="select" on-change="{{ on_select }}" visible?="{{ unused.length }}">
        <option disabled value="-1">property</option>
        <template repeat="{{ property, index in unused }}">
          <option value="{{ index }}">
            ({{ property.type }}) {{ property.name }}
          </option>
        </template>
      </select>
    </div>

  </template>
  <script>
    Polymer('part-collection-filter', {

      propertiesChanged: function () {
        this.used = [];
        this.unused = this.properties.slice();
      },

      on_select: function (event, detail, target) {
        var index = target.value;
        var property = this.unused.splice(index, 1)[0];
        this.used.push(property);
        this.$.select.value = '-1';
      },

      on_unselect: function (event, detail, target) {
        var index = target.dataset.index;
        var item = this.used.splice(index, 1)[0];
        this.unused.push(item);
        this.$.select.value = '-1';
      },

      get query () {
        var filters = this.$.filters.querySelectorAll('[filter]').array();
        var array = filters.map(function (filter) { return filter.query; });
        var and = { and: array };
        return and;
      }
      
    });
  </script>
</polymer-element>
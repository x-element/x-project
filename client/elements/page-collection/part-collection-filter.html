<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="../filter-text/filter-text.html">
<link rel="import" href="../filter-date/filter-date.html">
<link rel="import" href="../filter-number/filter-number.html">
<link rel="import" href="../filter-select/filter-select.html">
<link rel="import" href="../filter-x/filter-x.html">
<dom-module id="part-collection-filter">
  <style>
    :host {
      display: block;
      margin-bottom: 8px;
    }

    .filter {
      display: block;
      margin-bottom: 4px;
    }
    .filter filter-x {
      display: inline-block;
    }
  </style>
  <template>

    <div id="filters">
      <template is="dom-repeat" items="{{selected}}">
        <div class="filter">
          <filter-x filter property="{{item}}"></filter-x>
          <button class="btn btn-xs btn-default" item="{{item}}" on-click="deselect">delete</button>
        </div>
      </template>
    </div>
    
    <array-selector id="selector" items="{{items}}" selected="{{selected}}" multi toggle></array-selector>
    
    <select id="select" on-change="select">
      <option value="0">-</option>
      <template is="dom-repeat" items="{{items}}">
        <option value="{{item.name}}" item="{{item}}" 
          hidden?="{{item.selected}}" on-click="select">{{item.name}}</option>
      </template>
    </select>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'part-collection-filter',

    properties: {
      items: {
        type: Array
      },
      where: {
        type: Object,
        notify: true
      }
    },

    select: function (event) {
      var item = event.target.querySelector(':checked').item;
      this.$.select.value = 0;
      this.$.selector.select(item);
      this.set('item.selected', true);
    },

    deselect: function (event) {
      var item = event.target.item;
      this.$.select.value = 0;
      this.$.selector.deselect(item);
      this.set('item.selected', false);
    },

    get query () {
      var filters = this.$.filters.querySelectorAll('[filter]');
      var nodelist = Array.prototype.slice.call(filters);
      var array = nodelist.map(function (filter) { return filter.query; });
      var where = { and: array };
      this.where = where;
      return where;
    }
    
  });
</script>